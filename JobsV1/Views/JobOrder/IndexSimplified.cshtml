@model IEnumerable<JobsV1.Controllers.cJobOrder>

@{
    ViewBag.Title = "Work in Progress";
    Layout = "~/Views/Shared/_ModuleLayout.cshtml";
}


<h2>Job Orders</h2>
<div class="col-lg-12">

    <div class="col-lg-9">

        <p>
            @Html.ActionLink("Create New", "jobCreate", "JobOrder", null, null)
        </p>

        <p>
            Filters:
            @Html.ActionLink("OnGoing", "Index", new { sortid = 1 }, new { @id = "ongoing" }) |
            @Html.ActionLink("Previous", "Index", new { sortid = 2 }, new { @id = "previous" }) |
            @Html.ActionLink("Closed", "Index", new { sortid = 3 }, new { @id = "closed" })
        </p>
    </div>

    <div class="col-lg-3">
        <div class="form-group" style="width:350px;margin-right:0px">
            <div class="col-lg-5">
                <input type="text" maxlength="30" class="form-control" style="width:140px" id="src-field" />
            </div>
            <div class="col-lg-7">
                <button class="btn btn-default" style="margin-top:-0px;" onclick="ajaxSearch();">Search by Id</button>
            </div>
        </div>
    </div>
</div>
<table class="table">

@foreach (var item in Model) {
    <tr >
        <td id="main@(item.Main.Id)">
            <div style="background-color:white;text-align:center;border:1px solid #e0e0e0;padding:15px 0px;border-radius:5px;">
                <span style="color:blue; font: bold 14px arial, verdana;">@item.Main.JobDate.ToString("MMM-yyyy")</span>
                <br /><span style="color:blue; font: bold 30px arial, verdana;">@item.Main.JobDate.ToString("dd")</span>
                <span style="color:blue; font: bold 14px arial, verdana;">(@item.Main.JobDate.ToString("ddd"))</span>
                <br /><span style="color:red; font: normal 18px arial, verdana;">&nbsp;</span>
                
                @if (@item.Main.AgreedAmt != 0)
                {
                    <span style="color:blue; font: bold 12px arial, verdana;">
                        @string.Format("{0:N}", @item.Main.AgreedAmt)
                    </span>
                    <br />

                }

                @if (@item.Payment != 0)
                {
                    <span style="color:green; font: bold 10px arial, verdana;">
                        @string.Format("{0:N}", @item.Payment)
                    </span>
                    if (item.Main.JobPayments.Where(s => s.JobMainId == item.Main.Id).FirstOrDefault().BankId == 5)
                    {
                        <br />
                        <span>
                            Paid in
                            <img src="~/Images/paypal.png" width="20" height="20" alt="Paid through paypal" />
                        </span>
                    }
                }
            </div>
        </td>

        <td>
            <div class="panel panel-default" >
                <div class="panel-heading">
                    <span style="color:darkgreen;font:bold 16px arial, verdana;">

                        @if (item.Main.JobEntMains.FirstOrDefault() != null)
                        {
                            @item.Main.JobEntMains.FirstOrDefault().CustEntMain.Name
                            <text>-</text>
                        }

                        @item.Main.Customer.Name
                    </span>
                    @if (item.Main.JobStatus.Status == "INQUIRY")
                    {
                        <span class="pull-right label label-info">
                            @item.Main.JobStatus.Status
                        </span>
                    }
                    else if (item.Main.JobStatus.Status == "RESERVATION")
                    {
                        <span class="pull-right label label-primary">
                            @item.Main.JobStatus.Status
                        </span>
                    }
                    else if (item.Main.JobStatus.Status == "CONFIRMED")
                    {
                        <span class="pull-right label label-success">
                            @item.Main.JobStatus.Status
                        </span>
                    }
                    else
                    {
                        <span class="pull-right label label-default">
                            @item.Main.JobStatus.Status
                        </span>
                    }
                </div>

                <div class="panel-body">
                    @*<b style="font:500 10px;color:darkblue;"> </b>*@
                    <div class="list-group">
                        <a href="#" class="list-group-item" onclick="ShowJobServiceModal(@(item.Main.Id))"> @item.Main.Description </a>
                    </div>

                    <div class="btn-group" role="group" >
                        <a href="/JobOrder/JobServices?JobMainId=@item.Main.Id" type="button" class="btn btn-default"> Job Details </a>
                        <a href="/JobOrder/BookingDetails/@item.Main.Id" type="button" class="btn btn-default"> Booking </a>
                        <a href="/JobOrder/BookingDetails/@item.Main.Id?iType=1" type="button" class="btn btn-default"> Invoice </a>
                        <a href="#" class="btn btn-default" onclick="ShowPaymentModal(@(item.Main.Id))"> Payment </a>
                        <a href="/JobOrder/TextConfirmation/@item.Main.Id" type="button" class="btn btn-default"> Text Confirmation </a>
                    </div>
                 </div>
            </div>

        </td>
    </tr>
}
</table>

<!-- Partial Views -->
@{ Html.RenderPartial("PartialViewserviceListModal"); }



<!-- Modal Payment -->
<div class="modal fade" id="jobPayment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Payment Methods</h4>
            </div>
            <div class="modal-body" id="modal2-content">
                <h4>
                    Payment History
                </h4>
                <table class="table" id="paymentList">
                    <tr>
                        <th>Transaction Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </table>
                <div id="paymentActions">

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

@Html.Partial("PartialViewJS")

<p>
    @Html.ActionLink("Create New", "jobCreate", null, null)
    | Work In Progress
    | @Html.ActionLink("Listing", "JobListing", "JobOrder", new { span = 30 }, null)
    | @Html.ActionLink("Job Table", "JobTable", "JobMains", new { span = 30 }, null)
    | @Html.ActionLink("Availability", "Availability", "InvItems")
</p>

<p>
    Filters:
    @Html.ActionLink("OnGoing", "Index", new { sortid = 1 }, new { @id = "ongoing-bot" }) |
    @Html.ActionLink("Previous", "Index", new { sortid = 2 }, new { @id = "previous-bot" }) |
    @Html.ActionLink("Closed", "Index", new { sortid = 3 }, new { @id = "closed-bot" })
</p>

<!-- Modal -->
<div class="modal fade" id="Payment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Company List</h4>
            </div>

            <div class="modal-body" id="modal2-content">

                <div class="list-group" id="categorylist2">
                    <a href="@Url.Action("ChangeCompany", "JobOrder", new { id = 1}, null)" id="set1" class="list-group-item"> Partial Payment</a>
                    <a href="@Url.Action("ChangeCompany", "JobOrder", new { id = 1},null)" class="list-group-item"> Full Payment</a>
                    <a href="@Url.Action("ChangeCompany", "JobOrder", new { id = 1},null)" class="list-group-item"> Client Assurance</a>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script src="~/Scripts/jquery-3.3.1.js"> </script>
@section scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            initialize();

            var mainId = @(ViewBag.mainId);
            if(mainId != ''){

                $('html, body').animate({
                    scrollTop: $("#main@(ViewBag.mainId)").offset().top - 50
                }, 500);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const myParam = urlParams.get('search');
            $("#src-field").val(myParam);
        });

        
        function LoadOverlay(){
            $("#overlay2").css("display","flex");
        }

        
        function disableLoadOverlay(){
            $("#overlay2").css("display","none");
        }

        switch(@(Session["FilterID"] != null? (int)Session["FilterID"]: 1 )){
            case 1:
                $("#ongoing").css("color","black")
                $("#ongoing-bot").css("color","black")
                break;
            case 2:
                $("#previous").css("color","black")
                $("#previous-bot").css("color","black")
                break;
            case 3:
                $("#closed").css("color","black")
                $("#closed-bot").css("color","black")
                break;
            default:

                break;
        }

        function updateval(){
            var iDiv = $('#categorylist').val();

            // Now create and append to iDiv
            var innerDiv = document.createElement('p');
            innerDiv.className = 'list-group-item';

            // The variable iDiv is still good... Just append to it.
            iDiv.appendChild(innerDiv);
        }


        function ajaxSendMail(jobid) {
            var data = {
                jobId: jobid,
                mailType: "CLIENT-INVOICE-SEND"
            }

            var serviceURL = '/JobOrder/SendEmail';

            //loading screen
            LoadOverlay()

            //send email using ajax
            $.ajax({
                type: "POST",
                url: serviceURL,
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(){
                    console.log('success');
                    disableLoadOverlay();
                },
                error: function(jqXHR, textStatus, errorThrown) {

                    alert(jqXHR.responseText);
                    disableLoadOverlay();
                }
            });
        }

        /* Payments modal
         * Show Payment modal and retrieve the job payments history
         * and show actions with payments.
         */
        function ShowPaymentModal(jobId){
            $('#jobPayment').modal('show');
            getPaymentData(jobId);
        }
        
        /* JobService modal
         * Show Payment modal and retrieve the job payments history
         * and show actions with payments.
         */
        function ShowJobServiceModal(jobId){
            $('#jobServiceModal').modal('show');
            GetJobServiceData(jobId);
        }

        /**
        * Payment_Ajax
        * Get Payments transactions of the job
        * using the jobId 
        */
        function GetJobServiceData(jobId){
            var data = {
                jobId: jobId,
            }

            var serviceURL = '/JobOrder/GetJobServicesData';


            //send email using ajax
            $.ajax({
                type: "POST",
                url: serviceURL,
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){
                    console.log('success');
                    console.log(data);
                    jobPayments(data,jobId)
                    //disableLoadOverlay();
                },
                error: function(jqXHR) {

                    //alert(jqXHR.responseText);
                    //disableLoadOverlay();
                }
            });
        }

        
        /**
        * GET: JobServices Data
        * Get Payments transactions of the job
        * using the jobId 
        */
        function getPaymentData(jobId){
            var data = {
                jobId: jobId,
            }

            var serviceURL = '/JobOrder/GetPaymentHistory';


            //send email using ajax
            $.ajax({
                type: "POST",
                url: serviceURL,
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){
                    console.log('success');
                    console.log(data);
                    jobPayments(data,jobId)
                    //disableLoadOverlay();
                },
                error: function(jqXHR) {

                    alert(jqXHR.responseText);
                    //disableLoadOverlay();
                }
            });
        }

        
        

        function jobPayments(data,jobId){

            if(data["length"] != 0){
                
                console.log(data["0"]["Amount"]);
            //parse data response to json object
            var temp = data;

            //clear table contents except header
            $("#paymentList").find("tr:gt(0)").remove();

            //remove all link from div actions 
            $("#paymentActions").empty();

                //populate table content
                for (var x = 0; x < temp.length; x++) {
                    var content ="<tr>";
                    content += "<td>" + temp[x]["DtPayment"] + "</td>";
                    content += "<td>" + temp[x]["Type"] + "</td>";
                    content += "<td>" + temp[x]["Amount"] + "</td>";

                    content +="</tr>";
                    
                    console.log();
                    $(content).appendTo("#paymentList");
                }
            }

            var contentAction  = "<a href='/JobOrder/Payments/"+ jobId +"' class='list-group-item'>  Payment Transaction</a>" ;
            contentAction += "<a href='/JobOrder/PaymentCreate?JobMainId="+ jobId +"&remarks=Partial Payment' class='list-group-item'> Partial Payment </a>" ;
            contentAction += "<a href='/JobOrder/PaymentCreate?JobMainId="+ jobId +"&remarks=Full Payment' class='list-group-item'> Full Payment </a>" ;
            contentAction += "<a href='/JobOrder/PaymentCreatePG?JobMainId="+ jobId +"&remarks=Personal Guarentee' class='list-group-item'> Personal Guarantee </a>" ;

             //<a href="Url.Action("PaymentCreate", "JobOrder", new { JobMainId = item.Main.Id, remarks = "Partial Payment" }, null)" class="list-group-item"> Partial Payment</a>
             //<a href="Url.Action("PaymentCreate", "JobOrder", new { JobMainId = item.Main.Id, remarks = "Full Payment" }, null)" class="list-group-item"> Full Payment</a>
             //<a href="Url.Action("PaymentCreatePG", "JobOrder", new { JobMainId = item.Main.Id, remarks = "Personal Guarentee" }, null)" class="list-group-item"> Personal Guarantee</a>
             $(contentAction).appendTo("#paymentActions");
        }
        
        function ajaxSearch() {
            var data = {
                search: $("#src-field").val()
            }
            console.log("src: " + $("#src-field").val());
            var serviceURL = '/JobOrder';
            var searchString = $("#src-field").val();

            window.location.href = '/JobOrder/JobServices?JobMainId='+searchString;
            
            //window.location.href = '/JobOrder?search='+searchString;
        }
    </script>

}
