@model IEnumerable<JobsV1.Models.CustomerJobDetails >

@{
    ViewBag.Title = "PartialView_JobDetails";
    int customerid = Convert.ToInt32(ViewData["customerId"]);
}

<br /><br /><br />
<div class="row">

    <p>
        <b>Date: </b>
        <input id="startDate" type="date"  /> - 
        <input id="endDate" type="date" />

        <input type="button" value="Filter" class="btn btn-default"  style="margin-top:-10px;padding:5px;" onclick="detailsUpdate(30)" />
        &nbsp;&nbsp;&nbsp;
        <a onclick="getLastJobs(30)">Last 30 Days</a> |
        <a onclick="getLastJobs(60)">Last 60 Days</a>
    </p>
    <p>
        <b>Status: </b>
        <a onclick="statusUpdate('ALL')">ALL</a> | 
        <a onclick="statusUpdate('INQUIRY')">INQUIRY</a> | 
        <a onclick="statusUpdate('RESERVATION')">RESERVATION</a> | 
        <a onclick="statusUpdate('CONFIRMED')">CONFIRMED</a> | 
        <a onclick="statusUpdate('CLOSED')">CLOSED</a> | 
        <a onclick="statusUpdate('CANCELLED')">CANCELLED</a> 
    </p>
    <table  class="table table-striped">

        <tr style="border:1px solid lightgray">
            <th>Job Date </th>
            <th>Description </th>
            <th> No of Days </th>
            <th> No of Pax </th>
            <th> Status </th>
            <th>  </th>
        </tr>
        @foreach (var item in Model)
        {
         <tr style="border:1px solid lightgray">
            <td>
                @Html.DisplayFor(modelItem => item.JobDate)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Description)
            </td>
             <td>
                 @Html.DisplayFor(modelItem => item.NoOfDays) Day(s)
             </td>
            <td>
                @Html.DisplayFor(modelItem => item.NoOfPax) Person(s)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.StatusRemarks)
            </td>
            <td>
                @Html.ActionLink("Details", "BookingDetails", "JobOrder", new { id = item.Id }, null)
            </td>
        </tr>
        }

    </table>
    <h4>
        @Html.ActionLink("Add Job", "Create", "JobMains", new { id = customerid }, null)
    </h4>

</div>

<script src="~/Scripts/jquery-1.12.4.min.js"> </script>

<script>

    function Update() {
        var url_string = window.location.href;
        var url = new URL(url_string);
        var date1 = url.searchParams.get("sDate") != null ? url.searchParams.get("sDate") : getToday();
        var date2 = url.searchParams.get("eDate") != null ? url.searchParams.get("eDate") : getToday();
        var top = url.searchParams.get("top");
        var status = url.searchParams.get("status");

        $('#startDate').val(date1);
        $('#endDate').val(date2);
    }


    $(function () {
        Update();
    });

    $(document).load(function () {
        getLastJobs(30);
        Update();
    });

    function getToday() {

        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!
        var yyyy = today.getFullYear();

        if (dd < 10) {
            dd = '0' + dd
        }

        if (mm < 10) {
            mm = '0' + mm
        }

        today = yyyy + '-' + mm + '-' + dd;
        return today;
    }

    function statusUpdate(status) {

        var url_string = window.location.href;
        var url = new URL(url_string);
        var top = url.searchParams.get("top");

        var sDateVal = document.getElementById("startDate").value != "" ? document.getElementById("startDate").value : getToday();
        var eDateVal = document.getElementById("endDate").value != "" ? document.getElementById("endDate").value : getToday();
        var topVal = top;

        var requestString = "/Customers/Details/"+@customerid+"?";

        requestString += "top="+topVal+"&";

        if (eDateVal != null && sDateVal != null) {
            requestString = requestString + "sDate=" + sDateVal + "&eDate=" + eDateVal;
        }

        requestString += "&status=" + status

        window.location.href = requestString;

    }


    function detailsUpdate(top) {
        var sDateVal = document.getElementById("startDate").value != "" ? document.getElementById("startDate").value : getToday();
        var eDateVal = document.getElementById("endDate").value != "" ? document.getElementById("endDate").value : getToday();
        var topVal = top;


        var requestString = "/Customers/Details/"+@customerid+"?";

        requestString += "top="+topVal+"&";

        if (eDateVal != null && sDateVal != null) {
            requestString = requestString + "sDate=" + sDateVal + "&eDate=" + eDateVal;
        }
        requestString += "&status=ALL"


        window.location.href = requestString;

    }

    //get jobs from today to 30 previous days
    function getLastJobs(days) {
        var eDateVal = getToday();//end date = today
        var sDateVal = new Date();

        sDateVal.setDate(sDateVal.getDate() - days);

       // console.log(eDateVal);

        sDateVal = sDateVal.toLocaleString();

        console.log(sDateVal);

        var topVal = 10; //10 items

        var requestString = "/Customers/Details/"+@customerid+"?";

        requestString += "top="+topVal+"&";

        if (eDateVal != null && sDateVal != null) {
            requestString = requestString + "sDate=" + sDateVal + "&eDate=" + eDateVal;
        }
        requestString += "&status=" + status
    

        wait(5000);

        window.location.href = requestString;

    }
    function wait(ms){
        var start = new Date().getTime();
        var end = start;
        while(end < start + ms) {
            end = new Date().getTime();
        }
    }

</script>

