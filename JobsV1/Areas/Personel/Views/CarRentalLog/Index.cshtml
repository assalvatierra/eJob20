@model IEnumerable<JobsV1.Areas.Personel.Models.crLogTrip>

@{
    ViewBag.Title = "Trip Log";
    Layout = "~/Views/Shared/_ModuleLayout.cshtml";
}

<style>
    .PanelContainer-main {
        background-color: #eff3f6;
        border: none;
    }
</style>

<h2>Trip Log</h2>

<p>
    Trip Logs |
    @Html.ActionLink("Drivers", "Index", "crLogDrivers") |
    @Html.ActionLink("Units", "Index", "crLogUnits") |
    @Html.ActionLink("Companies", "Index", "crLogCompanies") |
    @Html.ActionLink("Odo", "Index", "CrLogOdoes", null, null) |
    @Html.ActionLink("Expenses", "Index", "CrLogFuels", null, null)
</p>
<p>
    @Html.ActionLink("Add New Trip", "Create") |
    @Html.ActionLink("Copy Trip", "CopyTrip") |
    @Html.ActionLink("Add Trip Odo", "UpdateTripLogOdo") |
    @Html.ActionLink("Cash Advance", "Index", "CarRentalCashRelease") |
    @Html.ActionLink("Reports", "ReportFilter")
</p>



<p>
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#FilterModal">Filter</button>
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#SummaryModal">Summary</button>
</p>

<!-- Filter Modal -->
<div class="modal fade" role="dialog" id="FilterModal" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" style="width:340px;">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"> Find Logs by Date</h4>
            </div>
            <div class="modal-body">
                <div class="row" style="margin-bottom:0px;padding:10px;padding-left:25px">
                    @using (Html.BeginForm())
                    {
                        <form id="FilterForm" method="post">
                            <p style="padding-left:0px;">
                                <label>Date options: </label><br />
                                <a class="cursor-pointer" onclick="SetStartDate(-7)"> This Week </a> |
                                <a class="cursor-pointer" onclick="SetStartDate(-15)"> Last 15 Days </a> |
                                <a class="cursor-pointer" onclick="SetStartDate(-30)"> Last 30 Days </a>
                            </p>

                            <div class="form-group" style="padding-right:5px;padding-bottom:10px;">
                                <label for="filter-date-label"> Start Date: </label>
                                <input type="text" name="startDate" id="filter-sdate" class="form-control" style="margin-bottom:10px;" />
                                <label for="filter-date-label"> End Date: </label>
                                <input type="text" name="endDate" id="filter-edate" class="form-control" />
                            </div>


                            <div class="form-group" style="padding-right:5px;padding-bottom:10px;">
                                <label for="filter-unit">Unit:</label>
                                <select name="unit" id="filter-unit" class="form-control">
                                    <option value="all">All</option>
                                    @foreach (var unit in ViewBag.crLogUnitList as List<JobsV1.Areas.Personel.Models.crLogUnit>)
                                    {
                                        <option value="@unit.Description"> @unit.Description </option>
                                    }
                                </select>
                            </div>

                            <div class="form-group" style="padding-right:5px;padding-bottom:10px;">
                                <label for="filter-driver">Driver:</label>
                                <select name="driver" id="filter-driver" class="form-control">
                                    <option value="all">All</option>
                                    @foreach (var unit in ViewBag.crLogDriverList as List<JobsV1.Areas.Personel.Models.crLogDriver>)
                                    {
                                        <option value="@unit.Name"> @unit.Name </option>
                                    }
                                </select>
                            </div>

                            <div class="form-group" style="padding-right:5px;padding-bottom:10px;">
                                <label for="filter-company">Company:</label>
                                <select name="company" id="filter-company" class="form-control">
                                    <option value="all">All</option>
                                    @foreach (var unit in ViewBag.crLogCompanyList as List<JobsV1.Areas.Personel.Models.crLogCompany>)
                                    {
                                        <option value="@unit.Name"> @unit.Name </option>
                                    }
                                </select>
                            </div>

                            <div class="form-group" style="padding-right:5px;padding-bottom:10px;">
                                <label for="sort-by">Sort:</label>
                                <select name="sortby" id="sort-by" class="form-control">
                                    <option value="Date"> Date Asc </option>
                                    <option value="Date-Desc"> Date Desc</option>
                                    <option value="Unit"> Unit </option>
                                    <option value="Company"> Company </option>
                                    <option value="Driver"> Driver </option>
                                </select>
                            </div>
                            <br />
                            <div class="col-lg-offset-5 col-md-7 col-xs-offset-5 col-xs-7">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<table class="table">
    <tr>
        <th>
            Date
        </th>
        <th>
            Driver
        </th>
        <th>
            Description
        </th>
        <th>
            Rate
        </th>
        <th>
            Addon
        </th>
        <th>
            Expense
        </th>
        <th>
            Driver
        </th>
        <th>
            Odo Start
        </th>
        <th>
            Odo End
        </th>
        <th></th>
    </tr>
    @{

        var count = 0;
        decimal totalRate = 0;
        decimal totalAddon = 0;
        decimal totalExpenses = 0;
        decimal totalDriverFee = 0;
    }
    @foreach (var item in Model)
    {

        count += 1;
        totalRate += item.Rate;
        totalAddon += item.Addon;
        totalExpenses += item.Expenses;
        totalDriverFee += item.DriverFee;

        <tr id="trip-@item.Id">
            <td>
                @item.DtTrip.ToString("MMM dd yyyy")
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.crLogDriver.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.crLogUnit.Description)
                /
                @Html.DisplayFor(modelItem => item.crLogCompany.Name)
                /
                @Html.DisplayFor(modelItem => item.Remarks)
            </td>
            <td>
                @item.Rate.ToString("#,##0.00")
            </td>
            <td>
                @item.Addon.ToString("#,##0.00")
            </td>
            <td>
                @item.Expenses.ToString("#,##0.00")
            </td>
            <td>
                @item.DriverFee.ToString("#,##0.00")
            </td>
            <td class="trip-OdoStart">
                @item.OdoStart
            </td>
            <td class="trip-OdoEnd">
                @item.OdoEnd
            </td>
            <td>
                @Html.ActionLink("Edit", "Edit", new { id = item.Id }) |
                @*@Html.ActionLink("Update Odo", "EditOdo", new { id = item.Id }) |*@
                <a class="cursor-pointer" onclick="Show_OdoUpdateModal('@item.Id')"> Update Odo </a> |
                @Html.ActionLink("Driver Summary", "DriverSummary", new { id = item.crLogDriverId })
            </td>
        </tr>
    }

    @{
        <tr>
            <td colspan="3">
                <p> Total Count: @count </p>
            </td>
            <td>
                @totalRate.ToString("#,##0.00")
            </td>
            <td>
                @totalAddon.ToString("#,##0.00")
            </td>
            <td>
                @totalExpenses.ToString("#,##0.00")
            </td>
            <td>
                @totalDriverFee.ToString("#,##0.00")
            </td>
            <td colspan="3"></td>
        </tr>
    }

</table>

@Html.Partial("_LogSummaryModal", null, new ViewDataDictionary { { "DriversLogSummary" , ViewBag.DriversLogSummary },
    { "CompaniesLogSummary", ViewBag.CompaniesLogSummary }, { "UnitsLogSummary", ViewBag.UnitsLogSummary } })

@Html.Partial("_LogOdoUpdateModal")

@section Scripts{
    <script src="~/Areas/Personel/Script/CarRentalLog.js"></script>
    <script src="~/Scripts/Filters/FormInputFilter.js"></script>
    <script>
        $(document).ready(() => {
            $("#filter-unit").val("@ViewBag.FilteredUnit")
            $("#filter-driver").val("@ViewBag.FilteredDriver")
            $("#filter-company").val("@ViewBag.FilteredCompany")
            $("#sort-by").val("@ViewBag.SortBy")

            if ("@ViewBag.FilteredsDate" != "") {
                $("#filter-sdate").val(moment("@ViewBag.FilteredsDate").format("MM/DD/YYYY"))
            } else {
                $("#filter-sdate").val(moment().format("MM/DD/YYYY"))
            }

            if ("@ViewBag.FilteredsDate" != "") {
                $("#filter-edate").val(moment("@ViewBag.FilteredeDate").format("MM/DD/YYYY"))
            } else {
                $("#filter-edate").val(moment().format("MM/DD/YYYY"))
            }
        });

        function SetStartDate(days) {
            let sDate = moment().format("MM/DD/YYYY");
            $("#filter-sdate").val(moment(sDate).add(days, 'days').format("MM/DD/YYYY"));
        }

        function Show_OdoUpdateModal(tripId) {
            $("#LogOdoUpdateModal").modal("show");
            $("#OdoUpdate-Id").val(tripId);

            //request odo details
            GetOdoDetails(tripId);
        }

        function GetOdoDetails(tripId) {
            if (tripId != null && tripId != 0) {
                $.get("/Personel/CarRentalLog/GetTripOdo", { id : parseInt(tripId) }, (response) => {
                    console.log(response);
                    if (response != null) {
                        $("#OdoUpdate-Start").val(response.Start);
                        $("#OdoUpdate-End").val(response.End);
                        $("#OdoUpdate-Date").text(response.Date);
                        $("#OdoUpdate-Driver").text(response.Driver);
                        $("#OdoUpdate-Unit").text(response.Unit);
                        $("#OdoUpdate-Company").text(response.Company);
                    } else {
                        alert('Unable to get trip odo details');
                    }
                });
            } else {
                alert('Unable to get trip odo details');
            }
        }

        function Submit_OdoUpdateForm() {
            var tripId = parseInt($("#OdoUpdate-Id").val());
            var odoStart = parseInt($("#OdoUpdate-Start").val());
            var odoEnd = parseInt($("#OdoUpdate-End").val());

            var odoData = {
                Id: tripId,
                OdoStart: odoStart,
                OdoEnd: odoEnd
            }
            console.log(odoData)

            $.post("/Personel/CarRentalLog/SetTripOdo", odoData, (response) => {
                console.log(response);
                if (response == 'True') {
                    //window.location.reload();
                    var tripLog = $("#trip-" + tripId);
                    tripLog.children(".trip-OdoStart").text(odoStart);
                    tripLog.children(".trip-OdoEnd").text(odoEnd);
                    $("#LogOdoUpdateModal").modal("hide");
                } else {
                    alert("An error occured while updating the trip details.");
                    $("#LogOdoUpdateModal").modal("hide");
                }
            });
        }

    </script>
}